#!/usr/bin/env bash

# Paths
readonly MR="$HOME/Projects/dm"

# Bazel
alias mono_compile_deps='(cd $HOME/Projects/bazel-deps; bazel run //:parse -- generate -r $MR -s 3rdparty/workspace.bzl -d 3rdparty/dependencies.yaml)'

# Bitbucket
bitbpr() {
  MESSAGE="$1"
  BRANCH=$(echo "$MESSAGE" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
  git checkout -b "$BRANCH"
  git add --a
  git commit -am "$MESSAGE"
  git push -u origin "$BRANCH"
  curl -X POST -H "Content-Type: application/json" -u "$BITBUCKET_USERNAME":"$BITBUCKET_PASSWORD" https://api.bitbucket.org/2.0/repositories/"$REPO"/pullrequests -d "{\"title\":\"$MESSAGE\",\"source\":{\"branch\":{\"name\":\"$BRANCH\"}},\"reviewers\":[{\"uuid\":\"{1dbb5f95-3ad8-49e5-a353-002a5c52b277}\"}],\"close_source_branch\":\"true\"}"
  printf "Pull request created: %s (%s)." "$BRANCH" "$MESSAGE"
}

# Gerrit
readonly GERRIT_MASTER='gerrit/master'
alias geco='git checkout $GERRIT_MASTER'
gecob() { git checkout -b "$1" "$GERRIT_MASTER"; }
ged() { git diff --color gerrit/master.."$1" | diff-so-fancy | less -RFX; }
alias gepr='git push gerrit HEAD:refs/for/master -o topic=$(git rev-parse --abbrev-ref HEAD)'
alias gerb='git stash; git rebase $GERRIT_MASTER; git stash pop'
alias geud='git remote update gerrit --prune'
alias gewip='git push gerrit HEAD:refs/for/master%wip -o topic=$(git rev-parse --abbrev-ref HEAD)'

# Mono Repository
alias mrcd='cd $MR'

# Kubernetes
alias kub_kafka='kubectl port-forward service/broker -n kafka 9092:9092'
alias kub_pw='kops get secrets kube --type secret -oplaintext --name kubernetes.mobi-telemetrie.spoud.io'
alias kub_reporting_api='kubectl port-forward reporting-api-test-77bcb6b779-8gz7h -n dashboard-alpha 9200:8080'
